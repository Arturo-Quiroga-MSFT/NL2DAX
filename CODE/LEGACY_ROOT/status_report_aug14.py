#!/usr/bin/env python3
"""
Power BI Query Execution Status Report - August 14, 2025
Final diagnostic update after 24+ hour monitoring
"""

import os
import sys
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()

def main():
    print("ğŸ“‹ POWER BI QUERY EXECUTION STATUS REPORT")
    print("=" * 70)
    print(f"ğŸ• Report Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("ğŸ“… Issue Duration: 24+ hours (since August 13, 2025)")
    print()
    
    print("ğŸ” CURRENT STATUS SUMMARY")
    print("-" * 40)
    print("âœ… Service Principal Authentication: WORKING")
    print("âœ… Workspace Access: WORKING")
    print("âœ… Dataset Metadata Access: WORKING")
    print("âŒ DAX Query Execution: FAILING")
    print("âŒ SQL Query Execution: FAILING")
    print("âŒ Capacity Accessibility: NOT VISIBLE")
    print()
    
    print("ğŸ†” TEST RESULTS BY DATASET")
    print("-" * 40)
    print("ğŸ“Š FIS-SEMANTIC-MODEL (3ed8f6b3-0a1d-4910-9d31-a9dd3f8f4007):")
    print("   â€¢ DAX Queries: âŒ HTTP 401 - PowerBINotAuthorizedException")
    print("   â€¢ SQL Queries: âŒ HTTP 401 - PowerBINotAuthorizedException")
    print("   â€¢ Diagnosis: Authorization/permission issue")
    print()
    print("ğŸ“Š AdventureWorks (fc4d80c8-090e-4441-8336-217490bde820):")
    print("   â€¢ DAX Queries: âŒ HTTP 400 - DatasetExecuteQueriesError")
    print("   â€¢ SQL Queries: âŒ HTTP 400 - DatasetExecuteQueriesError")
    print("   â€¢ Diagnosis: Query execution feature disabled")
    print()
    
    print("ğŸ¯ REFINED DIAGNOSIS")
    print("-" * 30)
    print("The different error codes suggest multiple issues:")
    print()
    print("1. ğŸ” CAPACITY/PERMISSION ISSUE (FIS dataset):")
    print("   â€¢ 401 errors indicate authorization problems")
    print("   â€¢ Capacity not accessible via user API")
    print("   â€¢ Service principal may lack dataset-level execute permissions")
    print()
    print("2. ğŸš« TENANT SETTING ISSUE (AdventureWorks dataset):")
    print("   â€¢ 400 errors indicate feature not enabled")
    print("   â€¢ 'Dataset Execute Queries REST API' may be disabled")
    print("   â€¢ Affects all datasets in tenant")
    print()
    
    print("ğŸ”§ IMMEDIATE ACTIONS REQUIRED")
    print("-" * 40)
    print("ğŸ‘¨â€ğŸ’¼ POWER BI ADMINISTRATOR TASKS:")
    print()
    print("1. ğŸ¢ TENANT SETTINGS:")
    print("   â€¢ Navigate to Power BI Admin Portal > Tenant Settings")
    print("   â€¢ Find 'Dataset Execute Queries REST API'")
    print("   â€¢ ENABLE for appropriate security groups")
    print("   â€¢ Wait 15-30 minutes for propagation")
    print()
    print("2. ğŸ­ CAPACITY MANAGEMENT:")
    print("   â€¢ Verify FIS workspace capacity assignment")
    print("   â€¢ Ensure capacity is running and accessible")
    print("   â€¢ Check XMLA Endpoint = 'Read Write'")
    print()
    print("3. ğŸ”‘ SERVICE PRINCIPAL PERMISSIONS:")
    print("   â€¢ Add service principal to workspace as Member/Admin")
    print("   â€¢ Grant 'Execute Queries' permission at dataset level")
    print("   â€¢ Verify Azure AD app registration permissions")
    print()
    
    print("ğŸ§ª VERIFICATION TESTS")
    print("-" * 30)
    print("After admin changes, run these tests:")
    print()
    print("ğŸ”„ Check tenant setting effect:")
    print("   export POWERBI_DATASET_ID=fc4d80c8-090e-4441-8336-217490bde820")
    print("   python3 compare_dax_sql.py")
    print("   Expected: 400 errors should change to 200 success")
    print()
    print("ğŸ”„ Check capacity/permission fix:")
    print("   export POWERBI_DATASET_ID=3ed8f6b3-0a1d-4910-9d31-a9dd3f8f4007")
    print("   python3 compare_dax_sql.py")
    print("   Expected: 401 errors should change to 200 success")
    print()
    print("ğŸ”„ Monitor capacity status:")
    print("   python3 fabric_capacity_status.py")
    print("   Expected: Workspace capacity should appear in accessible list")
    print()
    
    print("ğŸ“ ESCALATION PATH")
    print("-" * 25)
    print("If admin actions don't resolve the issue:")
    print("â€¢ Microsoft Support Case: https://powerbi.microsoft.com/support/")
    print("â€¢ Include this diagnostic report and all test outputs")
    print("â€¢ Reference: Service Principal Query Execution - 401/400 Errors")
    print()
    
    print("ğŸ“Š MONITORING SCHEDULE")
    print("-" * 30)
    print("After admin intervention:")
    print("â€¢ â° Immediate: Test after each admin change")
    print("â€¢ â° +15 min: Allow for tenant setting propagation")
    print("â€¢ â° +30 min: Final verification of all functionality")
    print("â€¢ â° +1 hour: Escalate if still not working")
    print()
    
    print("âœ… SUCCESS CRITERIA")
    print("-" * 25)
    print("Issue resolved when ALL of the following are true:")
    print("â€¢ âœ… fabric_capacity_status.py shows workspace capacity")
    print("â€¢ âœ… AdventureWorks queries return 200 (not 400)")
    print("â€¢ âœ… FIS dataset queries return 200 (not 401)")
    print("â€¢ âœ… diagnostic_summary.py reports SUCCESS")
    print()
    
    print(f"â° Report completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("ğŸ“‹ Next update: After admin intervention")

if __name__ == "__main__":
    main()
