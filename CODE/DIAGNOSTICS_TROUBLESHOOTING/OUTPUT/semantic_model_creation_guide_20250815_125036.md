# üìä Create New Semantic Model - Step by Step Guide

**Generated:** 2025-08-15 12:50:36

## üéØ Objective
Create a new Power BI semantic model connected directly to Azure SQL Database to ensure SQL and DAX queries use the same live data source.

## üîß Connection Details
- **Server:** `aqsqlserver001.database.windows.net`
- **Database:** `adventureworksdb`
- **Authentication:** Database (Username/Password)
- **Username:** `arturoqu`

## üìã Step-by-Step Instructions

### Step 1: Open Power BI Desktop
1. Launch Power BI Desktop
2. Click "Get Data" ‚Üí "More..."
3. Search for "Azure SQL Database" and select it
4. Click "Connect"

### Step 2: Configure Connection
1. **Server:** Enter `aqsqlserver001.database.windows.net`
2. **Database:** Enter `adventureworksdb`
3. **Data Connectivity mode:** Choose "Import"
4. Click "OK"

### Step 3: Authentication
1. Select "Database" authentication
2. **User name:** `arturoqu`
3. **Password:** Enter your password
4. Click "Connect"

### Step 4: Select Tables
Select these tables for import:
- ‚òëÔ∏è `FIS_CUSTOMER_DIMENSION`
- ‚òëÔ∏è `FIS_CA_DETAIL_FACT`
- ‚òëÔ∏è `FIS_CL_DETAIL_FACT`

Click "Load" to import the tables.

### Step 5: Create Relationships
In the Model view, create these relationships:

1. **Customer to Credit Arrangements:**
   - From: `FIS_CUSTOMER_DIMENSION[CUSTOMER_KEY]`
   - To: `FIS_CA_DETAIL_FACT[CUSTOMER_KEY]`
   - Cardinality: One-to-Many
   - Cross filter direction: Both

2. **Customer to Loans:**
   - From: `FIS_CUSTOMER_DIMENSION[CUSTOMER_KEY]`
   - To: `FIS_CL_DETAIL_FACT[CUSTOMER_KEY]`
   - Cardinality: One-to-Many
   - Cross filter direction: Both

### Step 6: Create Measures
Add these measures to improve DAX querying:

```dax
// Total Credit Amount
Total Credit Amount = SUM('FIS_CA_DETAIL_FACT'[LIMIT_AMOUNT])

// Total Exposure
Total Exposure = SUM('FIS_CA_DETAIL_FACT'[EXPOSURE_AT_DEFAULT])

// Customer Count
Customer Count = DISTINCTCOUNT('FIS_CUSTOMER_DIMENSION'[CUSTOMER_KEY])

// Average Credit Amount per Customer
Avg Credit per Customer = 
DIVIDE(
    [Total Credit Amount],
    [Customer Count]
)
```

### Step 7: Publish to Power BI Service
1. Click "Publish" in Power BI Desktop
2. Select your workspace: **"FIS"**
3. Wait for publish to complete
4. Note the dataset name that gets created

### Step 8: Update Environment Configuration
After publishing, update your `.env` file:

```bash
# Update these values with your new semantic model
POWERBI_DATASET_ID=<new_dataset_id_from_power_bi>
PBI_XMLA_ENDPOINT=powerbi://api.powerbi.com/v1.0/myorg/FIS

# Keep existing SQL connection (both will now use same data)
AZURE_SQL_SERVER=aqsqlserver001.database.windows.net
AZURE_SQL_DB=adventureworksdb
```

### Step 9: Test the Connection
1. Restart your Streamlit application
2. Run a test query: "Show me the top 5 customers by total credit amount"
3. Verify that SQL and DAX results are now consistent

## ‚úÖ Expected Results
After completing these steps:
- SQL queries will hit Azure SQL Database directly
- DAX queries will hit the new semantic model (connected to same database)
- Both should return identical row counts and values
- Data will always be in sync

## üîß Troubleshooting

### If datasets don't match:
1. Check the semantic model refresh status in Power BI Service
2. Manually refresh the dataset if needed
3. Verify firewall settings allow Power BI to access Azure SQL

### If XMLA endpoint doesn't work:
1. Ensure your workspace is Premium or Premium Per User
2. Check that XMLA endpoint is enabled for the workspace
3. Verify service principal has proper permissions

## üìû Support
If you encounter issues, check:
1. Azure SQL Database firewall rules
2. Power BI workspace permissions
3. Service principal access rights
4. Network connectivity between Power BI and Azure SQL

---

**Generated by NL2DAX Semantic Model Creator**
**Date: 2025-08-15 12:50:36**
